<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 修正后的CSP策略 -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://heifengzhaikengwang.github.io;
                   script-src 'self' 'unsafe-eval' 'wasm-unsafe-eval';
                   connect-src 'self';
                   media-src 'self' blob:">
    
    <!-- 根据实际路径调整base -->
    <base href="./"> 

    <!-- 移除预加载机制 -->
    <script src="ruffle.js" defer crossorigin="anonymous"></script>
</head>

<body>
    <div id="player-container" style="min-height:600px;background:#000;">
        <div class="loader"></div>
    </div>

    <script>
        (function() {
            async function init() {
                const MAX_RETRIES = 3;
                const BASE_DELAY = 1000;

                for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                    try {
                        const ruffle = await new Promise((resolve, reject) => {
                            const checkInterval = setInterval(() => {
                                if (window.RufflePlayer?.newest) {
                                    clearInterval(checkInterval);
                                    resolve(window.RufflePlayer.newest());
                                }
                            }, 100);

                            setTimeout(() => {
                                clearInterval(checkInterval);
                                reject(new Error('Ruffle初始化超时'));
                            }, 15000);
                        });

                        const container = document.getElementById('player-container');
                        const player = ruffle.createPlayer();
                        container.replaceChildren(player); // 安全清空容器

                        await Promise.race([
                            player.load('game.swf'),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('SWF加载超时')), 10000)
                            )
                        ]);
                        return; // 成功则退出
                    } catch (e) {
                        if (attempt === MAX_RETRIES - 1) {
                            showFatalError(e);
                            throw e;
                        }
                        await new Promise(r => setTimeout(r, BASE_DELAY * Math.pow(2, attempt)));
                    }
                }
            }

            // 错误处理
            function showFatalError(error) {
                const container = document.getElementById('player-container');
                container.innerHTML = `
                    <div style="color:red;padding:20px;">
                        <h2>加载失败</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()">重试</button>
                    </div>
                `;
            }

            window.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
