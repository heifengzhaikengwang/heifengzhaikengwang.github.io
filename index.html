<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震避险小游戏</title>
    
    <!-- CDN 优化方案 -->
    <link rel="dns-prefetch" href="https://cdn.bytedance.com">
    <link rel="preconnect" href="https://cdn.bytedance.com" crossorigin>
    
    <!-- 国内 CDN 加速 (字节跳动镜像) -->
    <script 
        src="https://cdn.bytedance.com/ruffle/ruffle.js" 
        defer 
        crossorigin="anonymous"
        integrity="sha384-xxx"> <!-- 需替换为实际哈希值 -->
    </script>

    <style>
        /* 原有样式保留 */
        body { margin: 0; padding: 20px; background-color: #f0f0f0; ... }
        .container { width: 100%; max-width: 1024px; ... }
        
        /* 新增加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>地震避险互动小游戏</h1>
    <div class="container">
        <!-- 静态播放器标签优化 -->
        <div id="ruffle-container" style="width:100%;height:0;padding-top:56.25%;position:relative">
            <div id="loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
                <div class="loader"></div>
                <p>资源加载中...</p>
            </div>
            <ruffle-player 
                id="mainPlayer" 
                style="width:100%;height:100%;display:none"
                autoplay="auto"
                background-color="#FFFFFF"
            ></ruffle-player>
        </div>
        <p class="notice">如果无法加载游戏，请尝试更新浏览器或使用最新版Chrome/Firefox浏览器</p>
    </div>

    <script>
        // Ruffle 运行时配置
        window.RufflePlayer = window.RufflePlayer || {};
        window.RufflePlayer.config = {
            autoplay: "auto",
            unmuteOverlay: "hidden",
            preferredRenderer: "webgl",
            logLevel: "error",
            contextMenu: false,
            preloader: {
                maxBufferedBytes: 5 * 1024 * 1024, // 预加载5MB数据
            }
        };

        // 性能监控标记
        window.addEventListener('DOMContentLoaded', () => {
            console.time('RuffleInit');
            
            const player = document.getElementById("mainPlayer");
            const loading = document.getElementById("loading");

            player.addEventListener('loadedmetadata', () => {
                console.timeEnd('RuffleInit');
                loading.style.display = "none";
                player.style.display = "block";
            });

            // 开始加载 SWF
            console.time('SWFDownload');
            player.load("/game.swf").then(() => {
                console.timeEnd('SWFDownload');
            }).catch((error) => {
                console.error("加载失败:", error);
                loading.innerHTML = `<p style="color:red">加载失败，请<a href="javascript:location.reload()">刷新重试</a></p>`;
            });
        });
    </script>
</body>
</html>
