<script>
    // 增强型Ruffle配置
    window.RufflePlayer = {
        config: {
            publicPath: "/", 
            autoplay: "on",
            backgroundColor: "#FFFFFF",
            scale: "noborder",
            warnOnUnsupportedContent: false,
            // 安全策略增强
            allowScriptAccess: false,
            allowNetworking: "none",
            openUrlMode: "deny",
            // 性能优化
            maxExecutionDuration: { secs: 30, nanos: 0 },
            logLevel: "error"
        }
    };

    // 可靠加载机制
    (function initRuffle() {
        const MAX_RETRY = 3;
        let retryCount = 0;

        function loadRuffle() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/ruffle.js?' + Date.now();
                script.onload = () => {
                    if (window.RufflePlayer?.newest) {
                        resolve();
                    } else {
                        reject(new Error('Ruffle未正确初始化'));
                    }
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function createPlayer() {
            try {
                const ruffle = window.RufflePlayer.newest();
                const player = ruffle.createPlayer();
                player.style.cssText = "width:100%;height:100%;";
                return player;
            } catch (error) {
                throw new Error('播放器创建失败: ' + error.message);
            }
        }

        async function initialize() {
            try {
                // 步骤1: 加载Ruffle核心
                await loadRuffle();
                
                // 步骤2: 创建播放器
                const container = document.getElementById("ruffle-container");
                const player = createPlayer();
                container.appendChild(player);

                // 步骤3: 加载SWF并验证
                const swfUrl = `/game.swf?cache=${Date.now()}`;
                const response = await fetch(swfUrl);
                
                if (!response.ok) {
                    throw new Error(`SWF请求失败 (HTTP ${response.status})`);
                }

                // 步骤4: 实际加载
                await player.load(swfUrl);
                
                // 步骤5: 性能监控
                player.addEventListener("loadedmetadata", () => {
                    console.log("SWF元数据加载完成:", 
                        `尺寸: ${player.width}x${player.height}`,
                        `帧率: ${player.metadata.frameRate}`
                    );
                });

            } catch (error) {
                console.error(`初始化失败 (尝试次数: ${retryCount + 1}/3)`, error);
                
                if (retryCount < MAX_RETRY) {
                    retryCount++;
                    console.warn(`2秒后重试...`);
                    setTimeout(initialize, 2000);
                } else {
                    document.getElementById("ruffle-container").innerHTML = 
                        `<p class="error">错误代码500: 资源加载失败<br>
                        <small>可能原因：<br>
                        1. 服务器文件配置错误<br>
                        2. SWF文件不兼容<br>
                        3. 网络限制问题</small></p>`;
                }
            }
        }

        // 启动初始化流程
        document.addEventListener("DOMContentLoaded", initialize);
    })();
</script>
