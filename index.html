<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典 Flash 游戏库 - heifengzhaikengwang</title>
    
    <!-- 核心文件加载 -->
    <script src="./ruffle.js"></script> <!-- 显式相对路径 -->

    <!-- 配置与初始化 -->
    <script>
        // 强化配置验证
        (function() {
            if (!window.RufflePlayer) {
                console.error("RufflePlayer 全局对象未定义");
                return;
            }

            // 精确配置参数
            window.RufflePlayer.config = Object.freeze({
                publicPath: new URL("./", window.location.href).href, // 动态计算路径
                polyfills: true,
                autoplay: "on",
                logLevel: "warn",
                compatibilityChecks: true
            });

            // 版本验证
            if (typeof window.RufflePlayer.newest !== 'function') {
                console.error("RufflePlayer.newest 不是有效函数");
                console.debug("当前 RufflePlayer 对象:", window.RufflePlayer);
            }
        })();
    </script>

    <style>
        /* 保持原有样式不变 */
    </style>
</head>
<body>
    <!-- 保持原有 DOM 结构不变 -->

    <script>
        // 强化初始化流程
        function initRuffle() {
            try {
                // 三级验证机制
                if (!window.RufflePlayer) throw Error("RufflePlayer 未定义");
                if (!window.RufflePlayer.newest) throw Error("newest() 方法缺失");
                
                const ruffle = window.RufflePlayer.newest();
                const container = document.getElementById('player-container');
                
                // 容器存在性检查
                if (!container) throw Error("播放器容器未找到");

                const player = ruffle.createPlayer();
                player.style.cssText = "width:100%;height:600px;";
                container.innerHTML = '';
                container.appendChild(player);

                // 异步加载测试
                player.load('game.swf').then(() => {
                    console.log("SWF 加载成功");
                }).catch(e => {
                    console.error("SWF 加载失败:", e);
                });

            } catch (error) {
                const errorHtml = `
                    <div style="color:#dc3545; padding:2rem; text-align:center;">
                        <h3>🚨 严重错误</h3>
                        <p>${error.message}</p>
                        <div style="margin-top:1rem;">
                            <button onclick="location.reload()" style="padding:0.5rem 1rem; background:#007bff; color:white; border:none; border-radius:4px;">
                                重新加载
                            </button>
                        </div>
                        <div style="margin-top:1rem; font-size:0.9em;">
                            <p>技术信息：</p>
                            <ul style="text-align:left; list-style:none;">
                                <li>Ruffle 版本: ${window.RufflePlayer?.version || '未知'}</li>
                                <li>核心文件状态: ${checkFileStatus()}</li>
                            </ul>
                        </div>
                    </div>
                `;
                document.getElementById('player-container').innerHTML = errorHtml;
            }
        }

        // 文件状态检查
        function checkFileStatus() {
            return [
                { name: 'ruffle.js', path: './ruffle.js' },
                { name: '核心模块', path: './core.ruffle.6434870f3ba01171ffe8.js' },
                { name: 'WASM 文件', path: './ruffle.wasm' }
            ].map(file => {
                try {
                    new URL(file.path, window.location.href);
                    return `<li>${file.name}: ✅ 路径有效</li>`;
                } catch {
                    return `<li>${file.name}: ❌ 路径无效</li>`;
                }
            }).join('');
        }

        // 安全启动
        if (document.readyState === 'complete') {
            initRuffle();
        } else {
            window.addEventListener('load', initRuffle);
        }
    </script>
</body>
</html>
