<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 关键修复1：调整CSP策略 -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://heifengzhaikengwang.github.io;
                  script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https:;
                  connect-src 'self' https://heifengzhaikengwang.github.io;
                  style-src 'self' 'unsafe-inline';
                  img-src * data:;
                  worker-src blob:;
                  object-src 'none'">
    
    <!-- 关键修复2：强制声明WASM MIME类型 -->
    <meta http-equiv="Wasm-Allowed" content="application/wasm">
    
    <base href="https://heifengzhaikengwang.github.io/">
    <title>经典游戏库</title>
    
    <!-- 优化加载顺序 -->
    <script>
        // 预配置Ruffle以防止初始化竞争
        window.RufflePlayer = window.RufflePlayer || {
            config: {
                publicPath: "/",
                polyfills: true,
                // 增强WASM加载策略
                wasmInit: "streaming",
                wasmLoadTimeout: 10000
            }
        };
    </script>
    <script src="ruffle.js" async></script>
</head>

<body>
    <!-- 保持原有DOM结构 -->
</body>

<script>
    // 增强版加载监控
    (function() {
        let wasmLoaded = false;
        
        // 1. 加载状态追踪
        function checkWasm() {
            if (!WebAssembly) {
                showError("浏览器不支持WebAssembly");
                return;
            }
            
            fetch("/ruffle.wasm", { method: 'HEAD' })
                .then(res => {
                    if (res.ok && res.headers.get('Content-Type') === 'application/wasm') {
                        wasmLoaded = true;
                        initializePlayer();
                    }
                })
                .catch(() => showError("WASM文件无法访问"));
        }

        // 2. 延迟初始化
        async function initializePlayer() {
            try {
                await new Promise(resolve => {
                    const check = setInterval(() => {
                        if (window.RufflePlayer?.newest) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                });

                const player = window.RufflePlayer.newest().createPlayer();
                document.getElementById('player-container').appendChild(player);
                
                // 3. 带重试机制的加载
                let retries = 3;
                const loadGame = async () => {
                    try {
                        await player.load('/game.swf');
                    } catch (e) {
                        if (retries-- > 0) {
                            console.log(`第${3-retries}次重试...`);
                            await loadGame();
                        } else {
                            throw e;
                        }
                    }
                };
                
                await loadGame();
            } catch (e) {
                showError(`加载失败: ${e.message}`);
            }
        }

        // 启动流程
        window.addEventListener('DOMContentLoaded', checkWasm);
    })();
</script>
</html>
