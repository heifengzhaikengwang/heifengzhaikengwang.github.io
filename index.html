<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SWF终极加载方案 - 黑风寨坑王</title>
    <script>
        // 第一阶段：环境预检
        (function precheck() {
            const swfUrl = new URL('./game.swf', window.location.href).href;
            console.log('[预检] SWF绝对路径:', swfUrl);
            
            // 实时检测文件可达性
            fetch(swfUrl, { method: 'HEAD' })
                .then(res => {
                    console.log('[预检] HTTP状态:', res.status);
                    console.log('[预检] 内容类型:', res.headers.get('Content-Type'));
                })
                .catch(console.error);
        })();
    </script>
</head>
<body>
    <div id="player-container" style="width:100%;height:100vh"></div>

    <!-- 强制指定Ruffle版本 -->
    <script src="https://unpkg.com/@ruffle-rs/ruffle@0.1.0-nightly.2024.4.18/ruffle.js"></script>

    <script>
        // 第二阶段：增强型加载器
        async function bulletproofLoader() {
            const SWF_URL = '/game.swf'; // 使用根路径
            
            try {
                // 步骤1：验证二进制完整性
                const swfResponse = await fetch(SWF_URL);
                if (!swfResponse.ok) {
                    throw new Error(`HTTP ${swfResponse.status} - ${swfResponse.statusText}`);
                }
                
                // 步骤2：验证SWF签名
                const swfBuffer = await swfResponse.arrayBuffer();
                const signature = new Uint8Array(swfBuffer.slice(0, 3));
                if (![70, 87, 83].every((v, i) => signature[i] === v)) { // FWS的ASCII码
                    throw new Error('无效的SWF文件签名');
                }

                // 步骤3：创建播放器实例
                const player = window.RufflePlayer.newest().createPlayer();
                document.getElementById('player-container').appendChild(player);

                // 步骤4：使用二进制数据加载（绕过URL加载）
                await player.load({
                    data: swfBuffer,
                    parameters: {
                        quality: 'high',
                        scale: 'exactFit'
                    }
                });

                console.log('SWF加载完成');
            } catch (error) {
                console.error('致命错误:', error);
                alert(`加载失败: ${error.message}\n请检查控制台获取详情`);
            }
        }

        // 启动加载流程
        window.addEventListener('DOMContentLoaded', bulletproofLoader);
    </script>
</body>
</html>
