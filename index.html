<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-eval' 'wasm-unsafe-eval'">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典 Flash 游戏库 - heifengzhaikengwang</title>
    
    <!-- 安全基础路径配置 -->
    <base href="https://heifengzhaikengwang.github.io/">

    <!-- 增加预加载和完整性校验 -->
    <link rel="preload" href="ruffle.js" as="script">
    <script 
        src="ruffle.js"
        integrity="sha384-...（实际哈希值）"
        crossorigin="anonymous"
        defer
    ></script>

    <!-- 增强型配置 -->
    <script>
        (function() {
            // 增加加载状态检测
            let ruffleLoaded = false;

            function checkRuffle() {
                if (!window.RufflePlayer) {
                    showError("Ruffle 核心库加载超时");
                    return;
                }
                ruffleLoaded = true;
                initializePlayer();
            }

            // 设置加载超时监控
            setTimeout(() => {
                if (!ruffleLoaded) {
                    showError("Ruffle 加载超时（>5秒）");
                }
            }, 5000);

            window.RufflePlayer = window.RufflePlayer || {
                config: {
                    publicPath: new URL(document.baseURI).pathname,
                    polyfills: true,
                    autoplay: "auto",
                    logLevel: "warn",
                    compatibilityChecks: true,
                    // 关键Wasm配置
                    openGLMode: "auto",
                    playerVersion: "latest"
                }
            };

            // 注册加载完成事件
            document.addEventListener('DOMContentLoaded', checkRuffle);
        })();

        // 增强错误处理
        function showError(message) {
            const container = document.getElementById('player-container');
            if (container) {
                container.innerHTML = `
                    <div class="error-container">
                        <h2>⚠️ 加载异常</h2>
                        <p>${message}</p>
                        <div class="diagnostics">
                            <p>诊断信息：</p>
                            <ul>
                                <li>UserAgent: ${navigator.userAgent}</li>
                                <li>Wasm支持: ${typeof WebAssembly !== 'undefined' ? '✅' : '❌'}</li>
                                <li>Ruffle状态: ${window.RufflePlayer ? '✅' : '❌'}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }
    </script>

    <style>
        /* 新增错误样式 */
        .error-container {
            padding: 2rem;
            background: #fff0f0;
            border-radius: 8px;
            margin: 2rem;
        }
        
        .diagnostics {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- 结构保持不变 -->

    <script>
        // 增强初始化逻辑
        async function initializePlayer() {
            try {
                const ruffle = window.RufflePlayer.newest();
                const player = ruffle.createPlayer();
                
                // 增加加载进度回调
                player.addEventListener('progress', (event) => {
                    console.log(`加载进度: ${Math.round(event.loaded / event.total * 100)}%`);
                });

                // 增加播放器事件监听
                player.addEventListener('loadedmetadata', () => {
                    console.log('SWF元数据加载完成');
                });

                player.addEventListener('error', (error) => {
                    console.error('播放器运行时错误:', error);
                    showError(`播放器错误: ${error.code}`);
                });

                // 使用绝对路径确保加载正确
                await player.load('/game.swf');
                document.getElementById('player-container').appendChild(player);

            } catch (error) {
                console.error('初始化失败:', error);
                showError(`初始化错误: ${error.message}`);
            }
        }
    </script>
</body>
</html>
