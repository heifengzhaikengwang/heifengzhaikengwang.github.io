<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- å®‰å…¨ç­–ç•¥é…ç½®ï¼ˆå·²é€‚é…GitHub Pagesï¼‰ -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://heifengzhaikengwang.github.io;
                  script-src 'self' https://heifengzhaikengwang.github.io;
                  style-src 'self' 'unsafe-inline';
                  connect-src 'self' blob:;
                  worker-src 'self' blob:;
                  img-src 'self' data:;
                  object-src 'none';
                  frame-src 'none'">

    <!-- åŠ¨æ€ç”Ÿæˆbaseæ ‡ç­¾è§£å†³è·¯å¾„é—®é¢˜ -->
    <script>
        document.write(`<base href="${location.protocol}//${location.host}${location.pathname.split('/').slice(0, -1).join('/')}/">`);
    </script>

    <!-- é¢„åŠ è½½ä¼˜åŒ–ï¼ˆè·¨åŸŸé…ç½®ï¼‰ -->
    <link rel="preload" href="ruffle.js" as="script">
    <link rel="preload" href="ruffle.wasm" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="game.swf" as="fetch">

    <title>ç»å…¸Flashæ¸¸æˆåº“</title>
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --bg-dark: #121212;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-dark);
            color: #e0e0e0;
        }
        #player-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 600px;
            position: relative;
        }
        .load-progress {
            height: 4px;
            background: var(--accent);
            width: 0%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            transition: width 0.4s ease;
        }
        .error-container {
            padding: 2rem;
            background: #2c0a0a;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® ç»å…¸æ¸¸æˆæ¡£æ¡ˆé¦†</h1>
        <p>Ruffle æŠ€æœ¯é©±åŠ¨ | æ°¸ä¹…ä¿å­˜ Flash é—äº§</p>
    </div>

    <div id="player-container">
        <div class="load-progress" id="progress-bar"></div>
    </div>

    <!-- å¢å¼ºç‰ˆåˆå§‹åŒ–é€»è¾‘ -->
    <script>
        (function() {
            // è¿›åº¦æ›´æ–°å‡½æ•°
            function updateProgress(percent) {
                const bar = document.getElementById('progress-bar');
                if (bar) bar.style.width = `${percent}%`;
            }

            // WASMåŠ è½½å™¨ï¼ˆå¸¦å¤‡ç”¨æ–¹æ¡ˆï¼‰
            async function loadWASM() {
                updateProgress(20);
                try {
                    const response = await fetch('ruffle.wasm', {
                        cache: 'force-cache',
                        headers: { 'Accept': 'application/wasm' }
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    // MIMEç±»å‹æ£€æŸ¥ï¼ˆå®½æ¾å¤„ç†ï¼‰
                    const contentType = response.headers.get('content-type') || '';
                    if (!contentType.includes('wasm')) {
                        console.warn('éæ ‡å‡†WASM MIMEç±»å‹:', contentType);
                    }
                    
                    updateProgress(60);
                    return await response.arrayBuffer();
                } catch (error) {
                    console.error('ä¸»WASMåŠ è½½å¤±è´¥:', error);
                    // å¤‡ç”¨CDNæº
                    updateProgress(40);
                    return fetch('https://unpkg.com/@ruffle-rs/ruffle@latest/ruffle.wasm')
                        .then(r => r.arrayBuffer());
                }
            }

            // RuffleåŠ è½½å™¨
            function loadRuffle() {
                updateProgress(10);
                return new Promise((resolve) => {
                    const script = document.createElement('script');
                    script.src = 'ruffle.js';
                    script.onload = () => {
                        updateProgress(30);
                        resolve();
                    };
                    script.onerror = () => {
                        // å¤‡ç”¨CDNåŠ è½½
                        const fallback = document.createElement('script');
                        fallback.src = 'https://unpkg.com/@ruffle-rs/ruffle@latest/ruffle.js';
                        document.head.appendChild(fallback);
                        fallback.onload = resolve;
                    };
                    document.head.appendChild(script);
                });
            }

            // é”™è¯¯æ˜¾ç¤º
            function showError(message, details = '') {
                const container = document.getElementById('player-container');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="error-container">
                        <h2 style="color: #ff4440;">âš ï¸ åŠ è½½é”™è¯¯</h2>
                        <p>${message}</p>
                        ${details && `<pre style="overflow-x: auto; color: #ccc;">${details}</pre>`}
                        <div style="margin-top: 1rem;">
                            <button onclick="window.location.reload()">é‡è¯•</button>
                            <p style="font-size: 0.8em; margin-top: 1em;">
                                æŠ€æœ¯æ”¯æŒ: æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯
                            </p>
                        </div>
                    </div>
                `;
            }

            // ä¸»åˆå§‹åŒ–æµç¨‹
            async function initialize(retryCount = 0) {
                try {
                    updateProgress(5);
                    
                    // å¹¶è¡ŒåŠ è½½å…³é”®èµ„æº
                    const [wasmBuffer] = await Promise.all([
                        loadWASM(),
                        loadRuffle()
                    ]);

                    updateProgress(70);
                    
                    // ç­‰å¾…Ruffleåˆå§‹åŒ–
                    await new Promise((resolve) => {
                        const checkInterval = setInterval(() => {
                            if (window.RufflePlayer?.newest) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 50);
                        
                        // è¶…æ—¶å¤„ç†
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            throw new Error('Ruffleåˆå§‹åŒ–è¶…æ—¶');
                        }, 5000);
                    });

                    updateProgress(80);
                    
                    const ruffle = window.RufflePlayer.newest();
                    const player = ruffle.createPlayer();
                    
                    // å¼ºåˆ¶æ ·å¼è®¾ç½®
                    player.style.cssText = `
                        width: 100% !important;
                        height: 600px !important;
                        background: #000 !important;
                        display: block !important;
                    `;

                    updateProgress(90);
                    
                    // åŠ è½½SWFå†…å®¹
                    await player.load('game.swf', {
                        parameters: {
                            quality: 'high',
                            allowScriptAccess: 'never'
                        }
                    });
                    
                    document.getElementById('player-container').replaceChildren(player);
                    updateProgress(100);
                    
                } catch (error) {
                    if (retryCount < 2) {
                        await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                        return initialize(retryCount + 1);
                    }
                    
                    showError(
                        'æ¸¸æˆåŠ è½½å¤±è´¥', 
                        `é”™è¯¯ç±»å‹: ${error.name}\n` +
                        `è¯¦ç»†ä¿¡æ¯: ${error.message}\n` +
                        `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n` +
                        `WASMæ”¯æŒ: ${typeof WebAssembly === 'object' ? 'æ˜¯' : 'å¦'}`
                    );
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            // å¯åŠ¨åˆå§‹åŒ–
            window.addEventListener('DOMContentLoaded', () => {
                // ç¯å¢ƒæ£€æµ‹
                if (typeof WebAssembly !== 'object') {
                    showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebAssembly', 'è¯·ä½¿ç”¨Chrome/Firefox/Edgeç­‰ç°ä»£æµè§ˆå™¨');
                    return;
                }
                
                initialize();
            });
        })();
    </script>
</body>
</html>
