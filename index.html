<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>黑风寨SWF托管系统</title>
    
    <!-- 深度性能优化区块 -->
    <link rel="preload" href="./ruffle.js" as="script">
    <link rel="modulepreload" href="./ruffle.wasm">
    <meta http-equiv="origin-trial" content="你的GitHub服务密钥">
    
    <!-- 自适应布局样式 -->
    <style>
        :root {
            --primary-color: #e74c3c; /* 与错误提示框主色匹配 */
            --background-gradient: linear-gradient(135deg, #e74c3c 0%, #e67e22 100%);
        }

        .ruffle-container {
            width: 90vw;
            height: 80vh;
            margin: 20px auto;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            background: var(--background-gradient);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- 增强错误提示框结构 -->
    <div id="error-panel" style="display:none;">
        <div class="error-header" style="background:var(--background-gradient);padding:15px;">
            <h2 style="color:white;margin:0;">⛔ 黑风寨系统告警</h2>
        </div>
        <div class="error-content" style="padding:20px;background:#f8f9fa;">
            <p id="error-message"></p>
            <button onclick="location.reload()" style="background:var(--primary-color);color:white;">重试加载</button>
            <a href="https://github.com/ruffle-rs/ruffle/wiki" target="_blank" style="color:var(--primary-color);">查看官方指南</a>
        </div>
    </div>

    <!-- 播放器容器 -->
    <div class="ruffle-container" id="swf-container"></div>

    <!-- Ruffle核心配置 -->
    <script>
        // GitHub Pages 专用路径解析
        const isGitHubIO = window.location.hostname === 'heifengzhaikengwang.github.io';
        
        window.RufflePlayer = {
            config: {
                publicPath: isGitHubIO ? 
                    "/" : /* 生产模式 */
                    window.location.pathname.replace(/\/[^/]+$/, "/") + "/" /* 开发模式 */,
                
                allowFullscreen: true,
                forceScale: true,
                quality: "high"
            },
            
            polyfills: true,
            
            // 增强错误处理（与错误面板联动）
            onError: function(errorType, errorDetail) {
                document.getElementById("error-panel").style.display = "block";
                document.getElementById("error-message").textContent = 
                    `[错误代码 ${errorType}] ${errorDetail}`;
            }
        };
    </script>

    <!-- 动态加载库文件 -->
    <script src="./ruffle.js"></script>

    <!-- 播放器控制逻辑 -->
    <script>
        const SWF_FILE = "/legacy.swf"; // 修改为你的SWF路径
        
        window.addEventListener("DOMContentLoaded", async () => {
            try {
                const ruffle = window.RufflePlayer.newest();
                const player = ruffle.createPlayer();
                document.getElementById("swf-container").appendChild(player);
                
                // 添加进度条
                player.addEventListener("progress", (e) => {
                    console.log(`加载进度: ${(e.loaded / e.total * 100).toFixed(1)}%`);
                });

                // 启动加载
                await player.load(SWF_FILE);
                
                // 自动播放控制
                player.play().catch(() => {
                    player.style.display = "block";
                });
            } catch (err) {
                console.error("[黑风寨诊断] 致命错误:", err.stack);
                window.RufflePlayer.onError(999, err.message);
            }
        });
    </script>
</body>
</html>
