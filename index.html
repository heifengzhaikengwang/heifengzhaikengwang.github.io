<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- å…³é”®å®‰å…¨ç­–ç•¥é…ç½® -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://heifengzhaikengwang.github.io;
                  script-src 'self' 'unsafe-inline' 'unsafe-eval';
                  style-src 'self' 'unsafe-inline';
                  connect-src 'self';
                  worker-src blob:;
                  img-src * data:;
                  object-src 'none'">

    <!-- åŸºç¡€è·¯å¾„é…ç½® -->
    <base href="https://heifengzhaikengwang.github.io/">

    <!-- Ruffleé¢„åŠ è½½ä¼˜åŒ– -->
    <link rel="preload" href="ruffle.js" as="script">
    <link rel="preload" href="ruffle.wasm" as="fetch" crossorigin>
    <link rel="preload" href="game.swf" as="fetch">

    <title>ç»å…¸Flashæ¸¸æˆåº“</title>
    
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        #player-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 600px;
            position: relative;
        }
        .loader { /* ä¿æŒåŠ è½½åŠ¨ç”»æ ·å¼ */ }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® ç»å…¸æ¸¸æˆæ¡£æ¡ˆé¦†</h1>
        <p>Ruffle æŠ€æœ¯é©±åŠ¨ | æ°¸ä¹…ä¿å­˜ Flash é—äº§</p>
    </div>

    <div id="player-container">
        <div class="loader"></div>
    </div>

    <!-- å¢å¼ºç‰ˆåˆå§‹åŒ–é€»è¾‘ -->
    <script>
        (function() {
            // å¼ºåˆ¶ç¼“å­˜æ¸…é™¤ç­–ç•¥
            const CACHE_BUSTER = '?v=' + Date.now().toString(16);
            
            // åŠ¨æ€åŠ è½½Ruffleæ ¸å¿ƒ
            const ruffleLoader = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'ruffle.js' + CACHE_BUSTER;
                script.integrity = 'sha384-...';  // æ›¿æ¢ä¸ºå®é™…SRIå“ˆå¸Œ
                script.crossOrigin = 'anonymous';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Ruffleæ ¸å¿ƒåŠ è½½å¤±è´¥'));
                document.head.appendChild(script);
            });

            // WASMåŠ è½½æ§åˆ¶
            const wasmLoader = fetch('ruffle.wasm' + CACHE_BUSTER)
                .then(res => {
                    if (!res.ok) throw new Error(`WASMè¯·æ±‚å¤±è´¥ (${res.status})`);
                    if (res.headers.get('Content-Type') !== 'application/wasm') {
                        throw new Error('æ— æ•ˆçš„WASM MIMEç±»å‹');
                    }
                    return res.arrayBuffer();
                });

            // æ’­æ”¾å™¨åˆå§‹åŒ–
            async function initialize() {
                try {
                    // å¹¶è¡ŒåŠ è½½å…³é”®èµ„æº
                    await Promise.all([ruffleLoader, wasmLoader]);
                    
                    // ç­‰å¾…Ruffleåˆå§‹åŒ–å®Œæˆ
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.RufflePlayer?.newest) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 50);
                    });

                    const ruffle = window.RufflePlayer.newest();
                    const player = ruffle.createPlayer();
                    
                    // å¼ºåˆ¶è®¾ç½®æ’­æ”¾å™¨æ ·å¼
                    player.style.cssText = `
                        width: 100%!important;
                        height: 600px!important;
                        background: #000!important;
                        display: block!important;
                    `;

                    // åŠ è½½æ¸¸æˆå†…å®¹
                    await player.load('game.swf' + CACHE_BUSTER);
                    document.getElementById('player-container').replaceChildren(player);

                } catch (e) {
                    showError(e.message);
                    console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }

            // å¯è§†åŒ–é”™è¯¯å¤„ç†
            function showError(msg) {
                const container = document.getElementById('player-container');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="padding: 2rem; background: #2c0a0a; border-radius: 8px;">
                        <h2 style="color: #ff4440;">âš ï¸ ä¸¥é‡é”™è¯¯</h2>
                        <p>${msg}</p>
                        <div style="margin-top: 1rem; color: #aaa;">
                            <p>è¯Šæ–­ä¿¡æ¯ï¼š</p>
                            <ul>
                                <li>æ—¶é—´æˆ³ï¼š${new Date().toISOString()}</li>
                                <li>ç”¨æˆ·ä»£ç†ï¼š${navigator.userAgent}</li>
                                <li>WASMæ”¯æŒï¼š${typeof WebAssembly === 'object' ? 'âœ…' : 'âŒ'}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            // å¯åŠ¨æµç¨‹
            window.addEventListener('DOMContentLoaded', initialize);
        })();
    </script>
</body>
</html>
