<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典 Flash 游戏库 - heifengzhaikengwang</title>
    
    <!-- 基础路径声明 (关键修复) -->
    <base href="https://heifengzhaikengwang.github.io/">
    
    <!-- 优先加载 Ruffle 核心文件 -->
    <script src="ruffle.js"></script>

    <!-- 强化配置验证 -->
    <script>
        (function() {
            // 强制初始化检查
            if (!window.RufflePlayer) {
                console.error("[致命错误] RufflePlayer 全局对象未定义");
                showError("Ruffle 核心库加载失败");
                return;
            }

            // 精确路径配置
            window.RufflePlayer.config = Object.freeze({
                publicPath: document.baseURI,  // 动态获取基础路径
                polyfills: true,
                autoplay: "on",
                logLevel: "debug",
                compatibilityChecks: true
            });

            // 版本兼容性验证
            try {
                if (typeof window.RufflePlayer.newest !== 'function') {
                    throw new Error("RufflePlayer.newest() 方法不可用");
                }
                console.info("Ruffle 核心模块验证通过");
            } catch (error) {
                console.error("Ruffle 初始化失败:", error);
                showError(error.message);
            }
        })();

        // 统一错误处理
        function showError(message) {
            const container = document.getElementById('player-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 2rem; background: #ffeef0; border-radius: 8px;">
                        <h2 style="color: #cf222e;">⚠️ 系统错误</h2>
                        <p>${message}</p>
                        <h3>诊断指南：</h3>
                        <ol>
                            <li>访问 <a href="/ruffle.js" target="_blank">ruffle.js</a> 验证文件存在</li>
                            <li>检查控制台 Network 标签的加载状态</li>
                            <li>强制刷新页面 <button onclick="location.reload()" style="padding: 4px 8px;">↻</button></li>
                        </ol>
                        <p style="margin-top: 1rem; color: #666;">
                            技术信息：${navigator.userAgent}
                        </p>
                    </div>
                `;
            }
        }
    </script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: white;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #player-container {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin: 2rem 0;
            position: relative;
            min-height: 600px;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 48px;
            height: 48px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎮 经典游戏档案馆</h1>
        <p>Ruffle 技术驱动 | 永久保存 Flash 遗产</p>
    </div>

    <div id="player-container">
        <div class="loader"></div>
    </div>

    <script>
        // 安全初始化流程
        function initializePlayer() {
            try {
                const ruffle = window.RufflePlayer.newest();
                const container = document.getElementById('player-container');
                
                // 创建播放器实例
                const player = ruffle.createPlayer();
                player.style.cssText = `
                    width: 100%;
                    height: 600px;
                    background: #000;
                `;
                
                // 清空容器并注入播放器
                container.innerHTML = '';
                container.appendChild(player);

                // 加载游戏内容
                player.load('game.swf')
                    .then(() => console.log('SWF 加载成功'))
                    .catch(e => {
                        console.error('SWF 加载失败:', e);
                        showError(`游戏加载失败: ${e.message}`);
                    });

            } catch (error) {
                console.error('播放器初始化异常:', error);
                showError(error.message);
            }
        }

        // 启动执行
        if (document.readyState === 'complete') {
            initializePlayer();
        } else {
            window.addEventListener('load', initializePlayer);
        }
    </script>
</body>
</html>
