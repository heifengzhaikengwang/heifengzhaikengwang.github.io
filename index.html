<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ä¿®å¤1ï¼šè°ƒæ•´CSPç­–ç•¥ -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https: 'unsafe-eval' 'wasm-unsafe-eval' blob: data:">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»å…¸ Flash æ¸¸æˆåº“ - heifengzhaikengwang</title>
    
    <!-- å…³é”®ä¿®å¤2ï¼šæ˜¾å¼æŒ‡å®šåŸºç¡€è·¯å¾„ -->
    <base href="https://heifengzhaikengwang.github.io/">

    <!-- å…³é”®ä¿®å¤3ï¼šæ·»åŠ Wasmé¢„åŠ è½½ -->
    <link rel="preload" href="ruffle.wasm" as="fetch" crossorigin="anonymous">
    
    <!-- å¢å¼ºåŠ è½½é¡ºåºæ§åˆ¶ -->
    <script defer src="ruffle.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        #player-container { background: #fff; border-radius: 12px; min-height: 600px; position: relative; }
        .loader { /* ä¿æŒåŸæœ‰åŠ è½½åŠ¨ç”»æ ·å¼ */ }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® ç»å…¸æ¸¸æˆæ¡£æ¡ˆé¦†</h1>
        <p>Ruffle æŠ€æœ¯é©±åŠ¨ | æ°¸ä¹…ä¿å­˜ Flash é—äº§</p>
    </div>

    <div id="player-container">
        <div class="loader"></div>
    </div>

    <!-- å…³é”®ä¿®å¤4ï¼šé‡æ„åˆå§‹åŒ–é€»è¾‘ -->
    <script>
        // å¢å¼ºç‰ˆåˆå§‹åŒ–æµç¨‹
        async function initializePlayer() {
            try {
                // å¼ºåˆ¶ç­‰å¾…Ruffleå®Œå…¨åˆå§‹åŒ–
                await new Promise((resolve, reject) => {
                    const checkInterval = setInterval(() => {
                        if (window.RufflePlayer?.newest) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);

                    setTimeout(() => {
                        clearInterval(checkInterval);
                        reject(new Error("RuffleåŠ è½½è¶…æ—¶ï¼ˆ5ç§’ï¼‰"));
                    }, 5000);
                });

                const ruffle = window.RufflePlayer.newest();
                const player = ruffle.createPlayer();
                
                // å¼ºåˆ¶è®¾ç½®æ’­æ”¾å™¨å°ºå¯¸
                player.style.cssText = `
                    width: 100%!important;
                    height: 600px!important;
                    background: #000!important;
                    display: block!important;
                `;

                // äº‹ä»¶ç›‘å¬å¢å¼º
                player.addEventListener('progress', (event) => {
                    console.log(`[åŠ è½½è¿›åº¦] ${event.loaded}/${event.total}`);
                });

                player.addEventListener('error', (error) => {
                    console.error('[æ’­æ”¾å™¨é”™è¯¯]', error);
                    showError(`æ’­æ”¾å™¨å¼‚å¸¸: ${error.code}`);
                });

                // æ˜ç¡®æŒ‡å®šSWFè·¯å¾„
                await player.load('/game.swf');
                
                // æ¸…ç©ºå®¹å™¨å¹¶æ³¨å…¥æ’­æ”¾å™¨
                const container = document.getElementById('player-container');
                container.innerHTML = '';
                container.appendChild(player);

            } catch (error) {
                console.error('[åˆå§‹åŒ–å¤±è´¥]', error);
                showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // å¢å¼ºé”™è¯¯å¤„ç†
        function showError(message) {
            const container = document.getElementById('player-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 2rem; background: #ffeef0; border-radius: 8px;">
                        <h2 style="color: #cf222e;">âš ï¸ ç³»ç»Ÿé”™è¯¯</h2>
                        <p>${message}</p>
                        <div style="margin-top: 1rem;">
                            <p>è¯Šæ–­ä¿¡æ¯ï¼š</p>
                            <ul>
                                <li>å½“å‰æ—¶é—´ï¼š${new Date().toLocaleString()}</li>
                                <li>ç”¨æˆ·ä»£ç†ï¼š${navigator.userAgent}</li>
                                <li>Wasmæ”¯æŒï¼š${typeof WebAssembly === 'object' ? 'âœ…' : 'âŒ'}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }

        // å¯åŠ¨æ§åˆ¶
        window.addEventListener('DOMContentLoaded', () => {
            initializePlayer().catch(e => showError(e.message));
        });
    </script>
</body>
</html>
