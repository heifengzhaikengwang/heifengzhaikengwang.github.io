<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 关键修复：简化CSP策略 -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://heifengzhaikengwang.github.io 'unsafe-eval'">
    
    <base href="https://heifengzhaikengwang.github.io/">
    
    <!-- 加载策略优化 -->
    <script>
        // 预加载关键资源
        const preload = url => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = url;
            link.as = url.endsWith('.wasm') ? 'fetch' : 'script';
            link.crossOrigin = 'anonymous';
            document.head.appendChild(link);
        };
        preload('ruffle.wasm');
        preload('game.swf');
    </script>
    
    <script src="ruffle.js" defer></script>
</head>

<body>
    <div id="player-container" style="min-height:600px;background:#000;">
        <div class="loader"></div>
    </div>

    <script>
        // 增强版初始化
        (function() {
            let retryCount = 0;
            
            async function init() {
                try {
                    const ruffle = await waitForRuffle();
                    const player = ruffle.createPlayer();
                    
                    // 强制更新DOM
                    const container = document.getElementById('player-container');
                    container.innerHTML = '';
                    container.appendChild(player);

                    // 带超时的加载
                    await Promise.race([
                        player.load('game.swf'),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('加载超时')), 10000)
                        )
                    ]);
                } catch (e) {
                    if (retryCount++ < 3) {
                        console.warn(`第${retryCount}次重试...`);
                        await init();
                    } else {
                        showFatalError(e);
                    }
                }
            }

            function waitForRuffle() {
                return new Promise((resolve, reject) => {
                    const interval = setInterval(() => {
                        if (window.RufflePlayer?.newest) {
                            clearInterval(interval);
                            resolve(window.RufflePlayer.newest());
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(interval);
                        reject(new Error('Ruffle未加载'));
                    }, 15000);
                });
            }

            // 启动
            window.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
